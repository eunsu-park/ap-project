# OMNI Database Downloader - ì‚¬ìš© ê°€ì´ë“œ

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
omni_database/
â”œâ”€â”€ config.py                      # ì„¤ì • íŒŒì¼
â”œâ”€â”€ create_tables.py               # í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ download_all.py                # ë©”ì¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ â­
â”œâ”€â”€ validate_schemas.py            # ìŠ¤í‚¤ë§ˆ ê²€ì¦
â”‚
â”œâ”€â”€ schemas/                       # í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜
â”‚   â”œâ”€â”€ base_schema.py
â”‚   â”œâ”€â”€ lowres_schema.py          # Low Res (55 ì»¬ëŸ¼)
â”‚   â””â”€â”€ highres_schema.py         # High Res (46/49 ì»¬ëŸ¼)
â”‚
â”œâ”€â”€ parsers/                       # ë°ì´í„° íŒŒì‹±
â”‚   â”œâ”€â”€ base_parser.py            # ê³µí†µ íŒŒì‹± ë¡œì§
â”‚   â”œâ”€â”€ lowres_parser.py          # Low Res íŒŒì„œ
â”‚   â””â”€â”€ highres_parser.py         # High Res íŒŒì„œ
â”‚
â””â”€â”€ downloaders/                   # ë‹¤ìš´ë¡œë“œ ë° DB ì‚½ì…
    â””â”€â”€ base_downloader.py        # ê³µí†µ ë‹¤ìš´ë¡œë”
```

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. í…Œì´ë¸” ìƒì„±

```bash
cd /Users/eunsupark/GitHub/ap-project/acquisition/omni
python create_tables.py
```

**ì¶œë ¥:**
```
============================================================
OMNI ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
============================================================
âœ“ omni ë°ì´í„°ë² ì´ìŠ¤ ì´ë¯¸ ì¡´ì¬

============================================================
Low Resolution í…Œì´ë¸” ìƒì„±
============================================================
í…Œì´ë¸” ìƒì„± ì¤‘: low_resolution (56 ì»¬ëŸ¼)
âœ“ í…Œì´ë¸” ìƒì„± ì™„ë£Œ
âœ“ 3ê°œ ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ

============================================================
High Resolution í…Œì´ë¸” ìƒì„±
============================================================
í…Œì´ë¸” ìƒì„± ì¤‘: high_resolution (47 ì»¬ëŸ¼, 1-min)
âœ“ í…Œì´ë¸” ìƒì„± ì™„ë£Œ
âœ“ 3ê°œ ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ
```

### 2. ë°ì´í„° ë‹¤ìš´ë¡œë“œ

**Low Resolution (2010-2024):**
```bash
python download_all.py --lowres --start 2010 --end 2024
```

**High Resolution (2023):**
```bash
python download_all.py --highres --start 2023 --end 2023
```

**ë‘˜ ë‹¤ (2020-2024):**
```bash
python download_all.py --lowres --highres --start 2020 --end 2024
```

### 3. ë°ì´í„° í™•ì¸

```bash
python download_all.py --status
```

---

## ğŸ“– ìƒì„¸ ì‚¬ìš©ë²•

### create_tables.py - í…Œì´ë¸” ìƒì„±

**ê¸°ë³¸ ì‚¬ìš©:**
```bash
python create_tables.py
```

**í…Œì´ë¸” ì¬ìƒì„±:**
```python
# create_tables.py ìˆ˜ì •
create_low_resolution_table(drop_if_exists=True)   # ì‚­ì œ í›„ ì¬ìƒì„±
create_high_resolution_table(drop_if_exists=True)
```

**5ë¶„ ë°ì´í„°ìš© í…Œì´ë¸”:**
```python
# create_tables.py ìˆ˜ì •
create_high_resolution_table(
    drop_if_exists=False, 
    include_5min=True  # GOES flux 3ê°œ ì»¬ëŸ¼ ì¶”ê°€
)
```

---

### download_all.py - ë°ì´í„° ë‹¤ìš´ë¡œë“œ

#### ê¸°ë³¸ ì˜µì…˜

| ì˜µì…˜ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `--lowres` | Low Res ë‹¤ìš´ë¡œë“œ | `--lowres` |
| `--highres` | High Res ë‹¤ìš´ë¡œë“œ | `--highres` |
| `--5min` | 5ë¶„ High Res (GOES flux) | `--5min` |
| `--start YEAR` | ì‹œì‘ ì—°ë„ | `--start 2010` |
| `--end YEAR` | ì¢…ë£Œ ì—°ë„ | `--end 2024` |
| `--save-raw` | ì›ë³¸ íŒŒì¼ ì €ì¥ | `--save-raw` |
| `--status` | DB ìƒíƒœ í™•ì¸ | `--status` |
| `--verify TABLE YEAR` | ë°ì´í„° ê²€ì¦ | `--verify low_resolution 2023` |

#### ì‚¬ìš© ì˜ˆì‹œ

**1. Low Res í•œ í•´ë§Œ:**
```bash
python download_all.py --lowres --start 2023 --end 2023
```

**2. High Res ì—¬ëŸ¬ í•´:**
```bash
python download_all.py --highres --start 2020 --end 2024
```

**3. ë‘˜ ë‹¤ + ì›ë³¸ íŒŒì¼ ì €ì¥:**
```bash
python download_all.py --lowres --highres --start 2023 --end 2023 --save-raw
```

**4. 5ë¶„ High Res:**
```bash
python download_all.py --highres --5min --start 2023 --end 2023
```

**5. ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸:**
```bash
python download_all.py --status
```

ì¶œë ¥:
```
============================================================
DATABASE STATUS
============================================================

low_resolution:
  Total records: 131,400
  Years: 15
    2010: 8,760 records
    2011: 8,760 records
    2012: 8,784 records
    ...

high_resolution:
  Total records: 525,600
  Years: 1
    2023: 525,600 records
```

**6. íŠ¹ì • ì—°ë„ ê²€ì¦:**
```bash
python download_all.py --verify low_resolution 2023
```

ì¶œë ¥:
```
============================================================
Verifying low_resolution - Year 2023
============================================================
Total records: 8,760
Date range: 2023-01-01 00:00:00 to 2023-12-31 23:00:00

Sample data (first 3 records):
  Record 1:
    datetime: 2023-01-01 00:00:00
    year: 2023
    decimal_day: 1
    hour: 0
    bz_gsm_nt: -2.3
    plasma_flow_speed_km_s: 450.5
```

---

## ğŸ”§ ê³ ê¸‰ ì„¤ì •

### config.py ìˆ˜ì •

**ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •:**
```python
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'omni',
    'user': 'eunsupark',
    'password': 'eunsupark',
    'log_queries': False  # Trueë¡œ ë°”ê¾¸ë©´ SQL ì¿¼ë¦¬ ë¡œê¹…
}
```

**ë°°ì¹˜ í¬ê¸° ì¡°ì •:**
```python
BATCH_SIZE = 1000  # ê¸°ë³¸ê°’, ë©”ëª¨ë¦¬ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥ (100-5000)
```

**íƒ€ì„ì•„ì›ƒ ì„¤ì •:**
```python
DOWNLOAD_TIMEOUT = 30  # ì´ˆ (ëŠë¦° ë„¤íŠ¸ì›Œí¬ëŠ” 60ìœ¼ë¡œ ì¦ê°€)
```

---

## ğŸ“Š ë°ì´í„° êµ¬ì¡°

### Low Resolution (Hourly)

**í…Œì´ë¸”:** `low_resolution`
**ì»¬ëŸ¼:** 56ê°œ (datetime + 55ê°œ)
**ì‹œê°„ í•´ìƒë„:** 1ì‹œê°„
**ì˜ˆìƒ ë ˆì½”ë“œ/ë…„:** ~8,760ê°œ

**ì£¼ìš” ì»¬ëŸ¼:**
- `datetime` (PRIMARY KEY)
- `year`, `decimal_day`, `hour`
- ìê¸°ì¥: `bx_gse_gsm_nt`, `by_gse_nt`, `bz_gse_nt`, `by_gsm_nt`, `bz_gsm_nt`
- í”Œë¼ì¦ˆë§ˆ: `proton_temperature_k`, `proton_density_n_cm3`, `plasma_flow_speed_km_s`
- ì¸ë±ìŠ¤: `kp_index`, `dst_index_nt`, `ae_index_nt`

### High Resolution (Minutely)

**í…Œì´ë¸”:** `high_resolution`
**ì»¬ëŸ¼:** 47ê°œ (1-min) / 50ê°œ (5-min)
**ì‹œê°„ í•´ìƒë„:** 1ë¶„
**ì˜ˆìƒ ë ˆì½”ë“œ/ë…„:** ~525,600ê°œ

**ì£¼ìš” ì»¬ëŸ¼:**
- `datetime` (PRIMARY KEY)
- `year`, `day`, `hour`, `minute`
- ìê¸°ì¥: `bx_gse_nt`, `by_gse_nt`, `bz_gse_nt`, `by_gsm_nt`, `bz_gsm_nt`
- í”Œë¼ì¦ˆë§ˆ: `temperature_k`, `proton_density_n_cc`, `flow_speed_km_s`
- ìœ„ì„± ìœ„ì¹˜: `sc_x_gse_re`, `sc_y_gse_re`, `sc_z_gse_re`
- ì¸ë±ìŠ¤: `ae_index_nt`, `sym_d_nt`, `sym_h_nt`

---

## ğŸ’¾ ë””ìŠ¤í¬ ìš©ëŸ‰

### ì˜ˆìƒ ìš©ëŸ‰ (ì••ì¶• ì „)

**Low Resolution:**
- 1ë…„: ~2 MB
- 15ë…„ (2010-2024): ~30 MB

**High Resolution:**
- 1ë…„: ~100 MB
- 15ë…„ (2010-2024): ~1.5 GB

**ì—¬ìœ  ê³µê°„:** ìµœì†Œ 2-3 GB ê¶Œì¥

---

## â±ï¸ ì˜ˆìƒ ì†Œìš” ì‹œê°„

### ë‹¤ìš´ë¡œë“œ + íŒŒì‹± + DB ì‚½ì…

**Low Resolution:**
- 1ë…„: ~30ì´ˆ
- 15ë…„: ~7-10ë¶„

**High Resolution:**
- 1ë…„: ~5-10ë¶„
- 15ë…„: ~2-3ì‹œê°„

**ë„¤íŠ¸ì›Œí¬ ì†ë„ì— ë”°ë¼ ë³€ë™**

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨

**ì¦ìƒ:**
```
âœ— HTTP error: 404 Client Error
```

**ì›ì¸:** URL íŒ¨í„´ ë³€ê²½ ë˜ëŠ” í•´ë‹¹ ì—°ë„ ë°ì´í„° ì—†ìŒ

**í•´ê²°:**
- NASA SPDF ì›¹ì‚¬ì´íŠ¸ì—ì„œ URL í™•ì¸
- `config.py`ì˜ `url_pattern` ìˆ˜ì •

### 2. íŒŒì‹± ì—ëŸ¬

**ì¦ìƒ:**
```
âœ— Parsing error: ...
```

**ì›ì¸:** Fortran í¬ë§· ë¶ˆì¼ì¹˜

**í•´ê²°:**
- ì›ë³¸ íŒŒì¼ ì €ì¥: `--save-raw`
- `/tmp/omni_raw/` ì—ì„œ íŒŒì¼ í™•ì¸
- í¬ë§· ë¬¸ìì—´ ìˆ˜ì •: `parsers/lowres_parser.py` ë˜ëŠ” `highres_parser.py`

### 3. DB ì‚½ì… ì‹¤íŒ¨

**ì¦ìƒ:**
```
âœ— Database insertion error: ...
```

**ì›ì¸:** ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜, ì¤‘ë³µ í‚¤

**í•´ê²°:**
```bash
# í…Œì´ë¸” ì¬ìƒì„±
python create_tables.py  # drop_if_exists=Trueë¡œ ìˆ˜ì •

# íŠ¹ì • ì—°ë„ ì‚­ì œ í›„ ì¬ì‹œë„
psql -U eunsupark -d omni -c "DELETE FROM low_resolution WHERE year = 2023;"
```

### 4. ë©”ëª¨ë¦¬ ë¶€ì¡±

**ì¦ìƒ:** í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë˜ëŠ” ë§¤ìš° ëŠë¦¼

**í•´ê²°:**
```python
# config.py ìˆ˜ì •
BATCH_SIZE = 100  # 1000ì—ì„œ 100ìœ¼ë¡œ ê°ì†Œ
```

### 5. íƒ€ì„ì•„ì›ƒ

**ì¦ìƒ:**
```
âœ— Timeout error (>30s)
```

**í•´ê²°:**
```python
# config.py ìˆ˜ì •
DOWNLOAD_TIMEOUT = 60  # 30ì—ì„œ 60ìœ¼ë¡œ ì¦ê°€
```

---

## ğŸ“ Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©

### ë‹¤ìš´ë¡œë“œ

```python
from config import DB_CONFIG, TABLE_CONFIGS
from parsers.lowres_parser import LowResParser
from downloaders.base_downloader import BaseDownloader

# Low Res ë‹¤ìš´ë¡œë” ìƒì„±
parser = LowResParser()
downloader = BaseDownloader(
    db_config=DB_CONFIG,
    table_config=TABLE_CONFIGS['low_resolution'],
    parser=parser
)

# ë‹¨ì¼ ì—°ë„ ë‹¤ìš´ë¡œë“œ
success = downloader.download_year(2023, save_raw_file=False)

# ì—¬ëŸ¬ ì—°ë„ ë‹¤ìš´ë¡œë“œ
results = downloader.download_multiple_years(2020, 2024)
print(f"Success: {results['success']}")
print(f"Failed: {results['failed']}")
```

### ë°ì´í„° ì¡°íšŒ

```python
from egghouse.database import PostgresManager
from config import DB_CONFIG

with PostgresManager(**DB_CONFIG) as db:
    # íŠ¹ì • ë‚ ì§œ ë²”ìœ„ ì¡°íšŒ
    data = db.select_date_range(
        'low_resolution',
        'datetime',
        start_date='2023-01-01',
        end_date='2023-01-31'
    )
    
    # DataFrameìœ¼ë¡œ ë³€í™˜
    df = db.to_dataframe('low_resolution', limit=1000)
    
    # ì¡°ê±´ ì¡°íšŒ
    geomagnetic_storms = db.select(
        'low_resolution',
        where={'year': 2023},
        conditions="dst_index_nt < -100"
    )
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

**ì´ˆê¸° ì„¤ì •:**
- [ ] PostgreSQL ì‹¤í–‰ ì¤‘
- [ ] `omni` ë°ì´í„°ë² ì´ìŠ¤ ì¡´ì¬
- [ ] egghouse ìµœì‹  ë²„ì „ ì„¤ì¹˜
- [ ] ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸

**í…Œì´ë¸” ìƒì„±:**
- [ ] `python create_tables.py` ì‹¤í–‰
- [ ] `low_resolution` í…Œì´ë¸” ìƒì„± í™•ì¸
- [ ] `high_resolution` í…Œì´ë¸” ìƒì„± í™•ì¸

**ë°ì´í„° ë‹¤ìš´ë¡œë“œ:**
- [ ] Low Res ë‹¤ìš´ë¡œë“œ ì™„ë£Œ
- [ ] High Res ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (ì„ íƒ)
- [ ] `--status`ë¡œ í™•ì¸
- [ ] `--verify`ë¡œ ê²€ì¦

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí–ˆë‹¤ë©´:

1. **ë°ì´í„° ë¶„ì„:**
   - Jupyter Notebookì—ì„œ ë°ì´í„° íƒìƒ‰
   - í†µê³„ ë¶„ì„, ì‹œê°í™”

2. **ë¨¸ì‹ ëŸ¬ë‹:**
   - ê¸°ì¡´ ëª¨ë¸ê³¼ í†µí•©
   - ìƒˆë¡œìš´ íŠ¹ì„± ì¶”ì¶œ

3. **ìë™í™”:**
   - Cron jobìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸
   - ë§¤ì¼/ë§¤ì£¼ ìµœì‹  ë°ì´í„° ë‹¤ìš´ë¡œë“œ

---

## ğŸ“š ì°¸ê³  ìë£Œ

- **OMNI2 ê³µì‹ ë¬¸ì„œ:** https://spdf.gsfc.nasa.gov/pub/data/omni/
- **egghouse ë¬¸ì„œ:** /Users/eunsupark/GitHub/egghouse/
- **PostgreSQL ë¬¸ì„œ:** https://www.postgresql.org/docs/

---

**ë¬¸ì œê°€ ìˆìœ¼ë©´ ì–¸ì œë“  ì•Œë ¤ì£¼ì„¸ìš”!** ğŸ˜Š