# Saliency Maps 완전 가이드: 기본 개념부터 해석까지

## 📚 목차

1. [기본 개념](#기본-개념)
2. [각 플롯의 의미](#각-플롯의-의미)
3. [해석 방법](#해석-방법)
4. [태양물리학 응용](#태양물리학-응용)
5. [FAQ](#faq)

---

## 기본 개념

### 🤔 Saliency Map이란?

**일상적 비유:**
```
사진을 보고 "이 사진은 고양이야"라고 판단할 때,
우리는 귀, 수염, 눈을 주로 본다.
배경이나 바닥은 거의 안 본다.

Saliency Map = "AI가 어디를 보고 판단했는지" 보여주는 지도
```

**수학적 정의:**
```
모델 출력을 y, 입력 이미지를 x라고 할 때,
Saliency = ∂y/∂x (출력이 입력에 얼마나 민감한가?)

높은 saliency = 이 픽셀을 바꾸면 예측이 크게 변함
낮은 saliency = 이 픽셀은 예측에 별 영향 없음
```

### 🔬 왜 필요한가?

**1. 모델 검증**
- 모델이 "올바른 이유"로 예측하는가?
- 우연히 맞춘 게 아닌가?

```
나쁜 예: 늑대 vs 개 분류기가 배경의 눈을 보고 판단
       (늑대 사진이 대부분 눈 배경이라서)
좋은 예: 실제로 동물의 얼굴 특징을 보고 판단
```

**2. 과학적 통찰**
- 어떤 태양 구조가 지자기 활동에 영향을 주는가?
- 언제가 가장 중요한 시점인가?

**3. 디버깅**
- 모델이 이상한 곳을 보고 있으면 → 데이터/모델 문제

---

## 각 플롯의 의미

### 1. Grad-CAM (Gradient-weighted Class Activation Mapping)

#### 📊 무엇을 보여주는가?

**원본 이미지 위에 색깔 오버레이:**
- 🔴 **빨강/노랑**: 매우 중요한 영역
- 🟢 **초록**: 중간 정도 중요
- 🔵 **파랑/보라**: 덜 중요한 영역

#### 🧮 어떻게 계산하는가?

```python
1. 모델의 마지막 Convolutional layer의 activation 추출
2. 예측값에 대한 gradient 계산
3. Gradient로 activation에 가중치 부여
4. 공간적으로 평균하여 heatmap 생성
```

**수식:**
```
Grad-CAM = ReLU(Σ [∂y/∂A^k] × A^k)

A^k: k번째 feature map
∂y/∂A^k: 그 feature map의 중요도
ReLU: 양수만 (증가시키는 영향만)
```

#### 📖 읽는 법

**예시 1: 활동 영역 포착**
```
원본: 태양 이미지에 밝은 활동 영역 2개
CAM:  그 중 하나만 빨갛게 표시

→ 해석: 모델은 왼쪽 활동 영역만 중요하게 봄
→ 의미: 오른쪽은 위치/크기가 덜 중요
```

**예시 2: 코로나홀 추적**
```
원본: 큰 어두운 코로나홀
CAM:  코로나홀 경계가 빨갛게

→ 해석: 코로나홀의 경계를 주목
→ 의미: 경계에서 태양풍 방출
```

**예시 3: 균일한 CAM**
```
원본: 복잡한 구조
CAM:  전체가 균일한 주황색

→ 해석: 모델이 이미지를 제대로 사용 안 함
→ 문제: 학습 실패 또는 데이터 문제
```

#### ⚠️ 주의사항

- Grad-CAM은 "마지막 conv layer"만 본다
- 초기 레이어의 세밀한 특징은 못 봄
- 해상도가 원본보다 낮음 (upsampling됨)

---

### 2. Full Sequence Analysis

전체 시퀀스를 4개 패널로 표시하는 종합 플롯.

#### 패널 1: Original SDO Image Sequence

**무엇을 보여주는가?**
```
[t=0][t=1][t=2]...[t=27]
모든 시간 스텝의 원본 이미지를 가로로 나열
```

**읽는 법:**
- 수평 방향 = 시간 흐름
- 밝은 영역 = 활동 영역, 플레어
- 어두운 영역 = 코로나홀, 필라멘트
- 빨간 선 = 가장 중요한 시점

**예시:**
```
t=0-5:   작은 활동 영역
t=6:     [빨간선] 플레어 발생!
t=7-10:  활동 영역 확대
t=11-27: 점점 조용해짐

→ 해석: t=6의 플레어가 결정적
```

#### 패널 2: Grad-CAM Saliency Sequence

**무엇을 보여주는가?**
```
각 시점의 원본 이미지 + Saliency overlay
색깔 = 중요도 (파랑→빨강)
```

**읽는 법:**
- 빨간 영역이 **이동**: 구조물의 진화 추적
- 빨간 영역이 **고정**: 특정 위치가 지속적으로 중요
- 밝기 **변화**: 시간에 따른 중요도 변화

**예시:**
```
t=0-5:   오른쪽 위가 빨강
t=6-10:  오른쪽 위 → 중앙으로 이동
t=11-27: 전체적으로 파랑

→ 해석: 활동 영역이 회전하면서 중요도 변화
→ 의미: 특정 위치(중앙)에 왔을 때 가장 효과적
```

#### 패널 3: Temporal Importance

**무엇을 보여주는가?**
```
Bar chart: 각 시간 스텝의 중요도
Line: 추세선
```

**계산 방법:**
```python
1. Baseline: 모든 이미지로 예측
2. Test: t번째 이미지를 0으로 만들고 예측
3. Importance[t] = |Baseline - Test|

→ 제거했을 때 변화가 크면 중요함
```

**읽는 법:**

**패턴 A: 초기 피크**
```
Importance:
████████ (t=0-3)
████     (t=4-10)
██       (t=11-27)

→ 해석: 초기 관측이 가장 중요
→ 의미: 선행 지표가 명확
→ 예: CME 발생 직전의 코로나 변화
```

**패턴 B: 후기 피크**
```
Importance:
██       (t=0-20)
████████ (t=21-27)

→ 해석: 최근 관측이 중요
→ 의미: 현재 상태가 결정적
→ 예: 태양풍 실시간 속도
```

**패턴 C: 중간 스파이크**
```
Importance:
██ ██ ██████████ ██ ██
      ↑ t=12

→ 해석: 특정 순간의 이벤트
→ 의미: Critical event 발생
→ 예: M-class 플레어 발생 시점
```

**패턴 D: 균일**
```
Importance:
████████████████████

→ 해석: 모든 시점이 비슷한 중요도
→ 의미 1: 시간적 누적 효과
→ 의미 2: 모델이 시간 정보 미사용 (문제)
```

#### 패널 4: Model Predictions

**무엇을 보여주는가?**
```
예측 시퀀스 (예: 8개 시점의 ap_Index)
초록 점 = Target 시점 (분석 대상)
```

**읽는 법:**
- **평탄**: 안정적 예측
- **급증/급감**: 큰 변화 예측
- **진동**: 주기적 패턴

**예시:**
```
Prediction:
5 → 5 → 5 → 15 → 20 → 18 → 10 → 8
        ↑ target

→ 해석: 갑작스러운 증가 예측
→ 의미: 강한 지자기 활동 예상
```

---

### 3. Comprehensive Saliency Analysis

3x4 그리드로 모든 정보를 한눈에.

#### Row 1: Grad-CAM (3 time points)

**t=0, t=middle, t=last 시점의 Grad-CAM**

비교 분석:
```
t=0:    활동 영역 A에 주목
t=14:   활동 영역 B로 이동
t=27:   전체적으로 분산

→ 모델의 "주의"가 이동함
```

#### Row 2: Integrated Gradients (3 time points)

**Grad-CAM과의 차이:**

| Grad-CAM | Integrated Gradients |
|----------|---------------------|
| 마지막 layer만 | 전체 네트워크 |
| 빠름 | 느림 |
| 해상도 낮음 | 해상도 높음 |
| 양수만 (ReLU) | 양수+음수 |

**IG의 특징:**
- 더 세밀한 디테일
- 이론적 보장 (속성 보존)
- 노이즈가 적음

**읽는 법:**
- Grad-CAM과 비슷하면 → 신뢰도 높음
- 다르면 → 복잡한 상호작용

#### Col 4: Temporal Importance & Channel Importance

**Temporal Importance:**
- 앞에서 본 것과 동일
- 시간별 중요도

**Channel Importance:**
```
Bar chart:
193Å: ████████████
211Å: ████████
304Å: █████

→ 193Å이 가장 중요
→ 고온 코로나 플라즈마가 핵심
```

---

### 4. Channel Comparison

모든 파장을 한 화면에 비교.

#### 구조

```
          t=0         t=important    t=last
193Å  [원본][CAM]   [원본][CAM]   [원본][CAM]
211Å  [원본][CAM]   [원본][CAM]   [원본][CAM]
304Å  [원본][CAM]   [원본][CAM]   [원본][CAM]
```

#### 파장별 특성

**193Å (Fe XII, 1-2 MK):**
- 뜨거운 코로나 플라즈마
- 활동 영역의 코어
- 작고 밝은 구조

**211Å (Fe XIV, 2 MK):**
- 활동 영역
- 코로나 루프
- 중간 크기 구조

**304Å (He II, 0.05 MK):**
- 크로모스피어 / 천이 영역
- 필라멘트
- 크고 어두운 구조

#### 비교 분석 예시

**예시 1: 193Å 집중**
```
193Å: 활동 영역이 빨갛게
211Å: 주변부만 약간
304Å: 거의 파랑

→ 고온 구조만 중요
→ 코로나 루프, 플레어
```

**예시 2: 304Å 두드러짐**
```
193Å: 약간
211Å: 중간
304Å: 크게 빨갛게

→ 저온 구조가 중요
→ 필라멘트 분출, CME 전조
```

**예시 3: 모두 중요**
```
193Å: 중심부 빨강
211Å: 중간 영역 빨강
304Å: 외곽 빨강

→ 다층 구조의 복합 효과
→ 전체적인 자기장 구조
```

---

## 해석 방법

### 🔍 단계별 분석 프로세스

#### Step 1: 전체 개요 파악

**Full Sequence Analysis를 먼저 본다**

질문:
1. 어느 시점이 중요한가?
2. 공간적 패턴이 있는가?
3. 시간에 따라 어떻게 변하는가?

#### Step 2: 공간적 패턴 분석

**Grad-CAM을 자세히 본다**

체크리스트:
- [ ] 활동 영역과 일치하는가?
- [ ] 특정 구조를 추적하는가?
- [ ] 물리적으로 말이 되는가?

#### Step 3: 시간적 패턴 분석

**Temporal Importance를 본다**

질문:
- 왜 그 시점이 중요한가?
- 원본 이미지에서 뭔가 일어났나?
- 선행 시간은 얼마나 되는가?

#### Step 4: 파장별 비교

**Channel Comparison을 본다**

분석:
- 어떤 온도 영역이 중요한가?
- 파장별 주목 영역이 다른가?
- 물리적 해석은?

### 🎯 좋은 결과 vs 나쁜 결과

#### ✅ 좋은 결과

**특징:**
1. **집중된 saliency**: 특정 영역이 명확히 밝음
2. **물리적 의미**: 알려진 구조(활동 영역, 코로나홀)와 일치
3. **시간적 변화**: Temporal importance에 명확한 패턴
4. **일관성**: Grad-CAM과 IG가 비슷한 영역 지목

**예시:**
```
Grad-CAM: 활동 영역 12345의 중심이 빨강
Temporal: t=8에 피크 (플레어 발생 2시간 전)
Channel: 193Å > 211Å > 304Å (고온 우세)

→ 해석: 플레어 전 고온 코로나 가열이 예측의 핵심
```

#### ❌ 나쁜 결과

**특징 1: 균일한 saliency**
```
전체가 균일한 주황색

→ 문제: 모델이 이미지 미사용
→ 원인: 학습 실패, 데이터 문제
```

**특징 2: 무작위 패턴**
```
의미 없는 곳이 밝음 (예: 태양 가장자리 밖)

→ 문제: Overfitting, 노이즈 학습
→ 원인: 정규화 부족, 데이터 오염
```

**특징 3: 시간 정보 무시**
```
Temporal importance가 완전 평탄

→ 문제: LSTM이 작동 안 함
→ 원인: 시계열 정보 손실
```

### 🔬 과학적 검증

**물리적으로 타당한가?**

체크리스트:
- [ ] 활동 영역을 보고 있는가?
- [ ] 코로나홀의 역할을 인식하는가?
- [ ] 플레어/CME와 연결되는가?
- [ ] 시간 스케일이 합리적인가?
- [ ] 파장별 차이가 설명 가능한가?

---

## 태양물리학 응용

### 🌞 Scenario 1: 플레어 예측

**상황:**
- 목표: X-class 플레어 24시간 전 예측
- 입력: 12시간 간격 관측 (28 time steps = 14일)

**기대되는 saliency 패턴:**

**Grad-CAM:**
```
플레어 발생 영역(활동 영역)이 빨강
특히 중성선(neutral line) 부근
```

**Temporal:**
```
플레어 12-48시간 전에 피크
(자기장 재구성 시작 시점)
```

**Channel:**
```
193Å, 211Å > 304Å
(고온 코로나 가열이 선행 지표)
```

**실제 관측과 비교:**
```python
# 플레어 카탈로그와 비교
if model_highlights_AR_before_flare:
    print("✓ 모델이 물리적으로 타당함")
else:
    print("⚠ 재검토 필요")
```

### 🌊 Scenario 2: 태양풍 속도 예측

**상황:**
- 목표: 지구 도착 태양풍 속도
- 입력: 코로나 관측

**기대되는 saliency 패턴:**

**Grad-CAM:**
```
코로나홀 영역이 밝음
특히 지구 방향 코로나홀
```

**Temporal:**
```
후기 time steps가 중요
(최근 코로나홀 상태가 더 중요)
```

**Channel:**
```
193Å > 211Å, 304Å
(코로나홀은 193Å에서 어둡게 보임)
```

### ⚡ Scenario 3: 지자기 폭풍 예측

**상황:**
- 목표: Kp/Dst 지수 예측
- 입력: CME + 코로나홀

**기대되는 saliency 패턴:**

**Grad-CAM:**
```
시나리오 A: CME 우세
  → CME 발생 영역이 빨강
  
시나리오 B: 고속 태양풍 우세
  → 코로나홀이 빨강
```

**Temporal:**
```
CME: 발생 직후가 중요
고속풍: 지속적으로 중요
```

**Channel:**
```
CME: 211Å, 304Å (분출 구조)
고속풍: 193Å (코로나홀)
```

### 📊 실제 사례 분석

**사례 1: 2012년 3월 7일 X5.4 플레어**

```
관측:
- 3월 5일: NOAA AR 11429 출현
- 3월 6일: M급 플레어 여러 번
- 3월 7일 00:24 UT: X5.4 플레어

모델 saliency:
- Grad-CAM: AR 11429의 중성선 집중
- Temporal: 3월 6일 (24시간 전) 피크
- Channel: 193Å > 211Å > 304Å

해석:
✓ 모델이 플레어 24시간 전의 코로나 가열을 포착
✓ 물리적으로 타당: 플레어 전 자기 재구성 단계
```

**사례 2: 2017년 9월 고속 태양풍**

```
관측:
- 대형 코로나홀이 지구 방향
- 600+ km/s 태양풍 도착

모델 saliency:
- Grad-CAM: 코로나홀 경계 집중
- Temporal: 최근 관측이 더 중요
- Channel: 193Å 우세

해석:
✓ 코로나홀 경계에서 태양풍 가속
✓ 실시간 코로나홀 크기가 중요
```

---

## 고급 주제

### 📐 Integrated Gradients의 수학

**기본 아이디어:**
```
"입력이 baseline(검은 이미지)에서 
 실제 이미지로 변할 때,
 예측은 어떻게 변하는가?"
```

**수식:**
```
IG(x) = (x - x₀) × ∫₀¹ ∂f/∂x(x₀ + α(x-x₀)) dα

x₀: baseline (보통 0)
x: 실제 입력
α: 0에서 1로 가는 경로
∫: 경로를 따라 적분
```

**실제 계산:**
```python
# 이산화: 적분 → 합
steps = 50
for i in range(steps):
    alpha = i / steps
    x_interp = baseline + alpha * (input - baseline)
    grad = compute_gradient(x_interp)
    attribution += grad / steps
```

**속성 (Properties):**
1. **Completeness**: 모든 기여도의 합 = 예측 변화
2. **Sensitivity**: 중요한 픽셀이 0이 될 수 없음
3. **Implementation Invariance**: 같은 함수는 같은 attribution

### 🎓 Grad-CAM의 한계와 대안

**한계:**
1. **해상도**: 마지막 conv layer의 해상도로 제한
2. **양수만**: ReLU 때문에 억제 효과를 못 봄
3. **단일 레이어**: 초기 레이어 무시

**대안:**

**1. Grad-CAM++**
```
개선: 픽셀별 가중치를 더 정교하게
결과: 여러 객체를 더 잘 구분
```

**2. Score-CAM**
```
개선: Gradient 대신 activation만 사용
결과: 더 안정적이지만 느림
```

**3. Layer-CAM**
```
개선: 여러 레이어 결합
결과: 더 세밀한 saliency
```

### 🧪 검증 방법

**1. Sanity Checks**

```python
# Test 1: Random model
random_model = initialize_random()
sal = compute_saliency(random_model, input)

# 기대: 무작위 패턴 (의미 없어야 함)

# Test 2: Random data
sal = compute_saliency(trained_model, random_noise)

# 기대: 균일하거나 무작위 (의미 없어야 함)
```

**2. Perturbation Test**

```python
# 중요한 영역 제거
important_region = sal > threshold
masked_input = input.clone()
masked_input[important_region] = 0

# 예측 변화 확인
pred_original = model(input)
pred_masked = model(masked_input)

# 기대: 큰 변화 (실제로 중요하다는 증거)
```

**3. Insertion/Deletion Curves**

```python
# Insertion: 중요한 픽셀부터 추가
# Deletion: 중요한 픽셀부터 제거

# 좋은 saliency: 빠르게 성능 회복/저하
# 나쁜 saliency: 느리게 변화
```

---

## FAQ

### Q1: Saliency가 모두 균일하면?

**원인:**
1. 모델이 이미지를 사용 안 함
2. Gradient가 너무 작음
3. 모델이 수렴 안 됨

**해결:**
```bash
python verify_image_usage.py  # 이미지 사용 확인
```

### Q2: Grad-CAM과 IG가 너무 다르면?

**정상적인 차이:**
- IG가 더 세밀함 (정상)
- 큰 구조는 비슷해야 함

**문제가 되는 차이:**
- 완전히 다른 영역 → 모델 불안정
- 해결: 더 많은 IG steps, regularization

### Q3: Temporal importance가 평탄하면?

**원인:**
1. 모델이 시간 정보 미사용
2. 모든 시점이 정말 비슷하게 중요
3. LSTM이 작동 안 함

**확인:**
```python
# 각 시점을 개별적으로 제거하고 확인
for t in range(seq_len):
    # 실제로 예측이 변하는지
```

### Q4: 채널 중요도가 모두 비슷하면?

**해석:**
- 모든 온도 범위가 기여
- 복잡한 물리 과정
- 좋은 신호!

**하지만 완전히 동일하면:**
- 채널을 구분 못 함
- 데이터 문제 가능성

### Q5: 물리적으로 이상한 곳을 보면?

**예: 태양 밖 가장자리가 밝음**

**원인:**
1. Overfitting
2. 데이터 처리 artifact
3. 정규화 문제

**해결:**
1. 더 많은 데이터
2. Regularization 강화
3. 데이터 augmentation

### Q6: 시간 해상도가 맞지 않으면?

**예: 12시간 간격인데 1시간 단위 현상 포착?**

**불가능:**
- Nyquist 정리: 최소 2배 샘플링 필요
- 12시간 → 24시간 주기까지만

**해결:**
- 더 높은 시간 해상도 데이터
- 또는 목표를 장기 예측으로 조정

### Q7: 결과가 샘플마다 너무 다르면?

**정상적인 변동:**
- 다른 상황 → 다른 saliency (정상)

**비정상적인 변동:**
- 완전히 무작위 → 모델 불안정
- 항상 동일 → 모델이 입력 무시

**확인:**
```python
# 여러 샘플의 saliency 평균
avg_saliency = np.mean(all_saliency_maps, axis=0)

# 평균에서 의미 있는 패턴이 있어야 함
```

---

## 요약

### 핵심 개념

1. **Saliency = 중요도 지도**
   - 모델이 어디를 보는가

2. **Grad-CAM = 빠르고 직관적**
   - 공간적 패턴 파악

3. **Integrated Gradients = 정확하고 이론적**
   - 정량적 분석

4. **Temporal Importance = 시간별 중요도**
   - 언제가 중요한가

5. **Channel Comparison = 파장별 비교**
   - 어떤 온도가 중요한가

### 분석 체크리스트

- [ ] Saliency가 집중되어 있는가?
- [ ] 물리적으로 타당한가?
- [ ] 시간적 패턴이 있는가?
- [ ] 여러 방법이 일치하는가?
- [ ] 실제 관측과 맞는가?

### 다음 단계

1. **검증**: Perturbation test
2. **해석**: 물리적 의미 부여
3. **개선**: Ablation study
4. **발표**: 논문 figure 작성

---

**참고 문헌**

1. Selvaraju et al. (2017) "Grad-CAM: Visual Explanations from Deep Networks"
2. Sundararajan et al. (2017) "Axiomatic Attribution for Deep Networks"
3. Adebayo et al. (2018) "Sanity Checks for Saliency Maps"

**작성**: 2025-01-11  
**버전**: 1.0
